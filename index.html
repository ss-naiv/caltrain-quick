<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#E31837">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Caltrain">
  <title>Caltrain Quick</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --red: #E31837;
      --gray: #333;
      --light-gray: #f5f5f5;
      --local: #6B7280;
      --limited: #0891B2;
      --express: #E31837;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light-gray);
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom);
    }
    header {
      background: var(--red);
      color: white;
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 20px; font-weight: 600; }
    .service-type {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card-title {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 20px;
    }
    .favorites {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .fav-btn {
      padding: 8px 14px;
      background: var(--light-gray);
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .fav-btn:hover, .fav-btn.active { background: #ddd; }
    .train-section { margin-bottom: 16px; }
    .train-section:last-child { margin-bottom: 0; }
    .section-header {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-toggle {
      width: 100%;
      padding: 10px 12px;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    .section-toggle:hover { background: #f0f0f0; border-color: #ddd; }
    .section-toggle svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .section-toggle.open { background: #f5f5f5; }
    .section-toggle.open svg { transform: rotate(180deg); }
    .section-toggle-text { display: flex; gap: 8px; align-items: center; }
    .section-count {
      background: #e5e5e5;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    .section-time { color: #999; font-size: 12px; }
    .collapsible-list {
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .collapsible-list.open { display: flex; }
    .collapsible-list .train { background: #fafafa; }
    .train-list { display: flex; flex-direction: column; gap: 8px; }
    .train {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--light-gray);
      border-radius: 8px;
      gap: 12px;
    }
    .train-time {
      font-size: 24px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      min-width: 80px;
    }
    .train-info { flex: 1; }
    .train-number { font-size: 14px; color: #666; }
    .train-type {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .type-local { background: #E5E7EB; color: var(--local); }
    .type-limited { background: #CFFAFE; color: var(--limited); }
    .type-express { background: #FEE2E2; color: var(--express); }
    .train-eta {
      font-size: 14px;
      font-weight: 500;
      text-align: right;
      min-width: 60px;
    }
    .eta-now { color: var(--express); }
    .eta-soon { color: #F59E0B; }
    .no-trains {
      text-align: center;
      padding: 32px;
      color: #666;
    }
    .direction-toggle {
      display: flex;
      margin-bottom: 12px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .dir-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .dir-btn.active {
      background: var(--gray);
      color: white;
    }
    .dir-btn:disabled {
      background: #f5f5f5;
      color: #bbb;
      cursor: not-allowed;
    }
    .setup-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }
    .setup-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
    }
    .setup-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .setup-desc { color: #666; margin-bottom: 20px; font-size: 14px; }
    .setup-btn {
      width: 100%;
      padding: 14px;
      background: var(--red);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
    }
    .hidden { display: none !important; }
    .swap-container {
      display: flex;
      justify-content: center;
      margin: -8px 0;
      position: relative;
      z-index: 1;
    }
    .swap-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .swap-btn:hover { border-color: var(--red); }
    .swap-btn:active { transform: scale(0.95); }
    .swap-btn svg { width: 20px; height: 20px; stroke: #666; }
    .swap-btn:hover svg { stroke: var(--red); }
    .reversed-banner {
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      color: #92400E;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .reversed-banner button {
      background: #F59E0B;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .expiry-warning {
      background: #FEE2E2;
      color: #991B1B;
      padding: 10px 16px;
      font-size: 13px;
      text-align: center;
    }
    footer {
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: #999;
    }
    footer a { color: #666; }
    footer .footer-links { display: flex; justify-content: center; gap: 16px; }
    .live-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 500;
    }
    .status-ontime { background: #D1FAE5; color: #065F46; }
    .status-early { background: #FEF3C7; color: #92400E; }
    .status-late { background: #FEE2E2; color: #991B1B; }
    .status-loading { background: #E5E7EB; color: #6B7280; }
    .api-input {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 12px;
      font-family: monospace;
    }
    .api-help {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .api-help a { color: var(--red); }
    .btn-row { display: flex; gap: 8px; }
    .btn-row button { flex: 1; }
    .btn-secondary {
      padding: 12px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .api-status {
      font-size: 12px;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    .api-status.connected { background: #D1FAE5; color: #065F46; }
    .api-status.disconnected { background: #FEE2E2; color: #991B1B; }
  </style>
</head>
<body>
  <header>
    <h1>Caltrain Quick</h1>
    <span class="service-type" id="serviceType">Weekday</span>
  </header>

  <div class="expiry-warning hidden" id="expiryWarning">
    Schedule may be outdated. New schedule available.
  </div>

  <div class="container">
    <div class="reversed-banner hidden" id="reversedBanner">
      <span>Showing return trains</span>
      <button id="resetTrip">Back to home</button>
    </div>

    <div class="card">
      <div class="card-title" id="fromLabel">From</div>
      <select id="homeStation" disabled>
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="swap-container">
      <button class="swap-btn" id="swapBtn" title="Check return trains">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16"/>
        </svg>
      </button>
    </div>

    <div class="card">
      <div class="card-title" id="toLabel">To</div>
      <div class="direction-toggle">
        <button class="dir-btn active" data-dir="n">North (SF)</button>
        <button class="dir-btn" data-dir="s">South (SJ)</button>
      </div>
      <select id="destStation">
        <option value="">Select destination</option>
      </select>
      <div class="favorites" id="favorites"></div>
    </div>

    <div class="card">
      <div class="card-title">Trains</div>
      <div id="trainList">
        <div class="no-trains">Select a destination to see trains</div>
      </div>
    </div>
  </div>

  <footer>
    Schedule valid until <span id="validUntil">-</span>
    <div class="footer-links">
      <a href="#" id="changeHome">Change station</a>
      <a href="#" id="openApiSettings">Live status</a>
    </div>
  </footer>

  <div class="setup-modal hidden" id="apiModal">
    <div class="setup-content">
      <div class="setup-title">Live Train Status</div>
      <div id="apiStatus" class="api-status disconnected">No API key configured</div>
      <div class="api-help">
        Get real-time delays for trains departing within the hour.
        <a href="https://511.org/open-data/transit" target="_blank">Sign up for a free 511.org API key</a>,
        then paste it below (or paste the whole email - we'll find it).
      </div>
      <input type="text" id="apiKeyInput" class="api-input" placeholder="Paste API key or email...">
      <div class="btn-row">
        <button class="btn-secondary" id="apiCancel">Cancel</button>
        <button class="setup-btn" id="apiSave" style="margin:0">Save Key</button>
      </div>
    </div>
  </div>

  <div class="setup-modal hidden" id="setupModal">
    <div class="setup-content">
      <div class="setup-title">Welcome to Caltrain Quick</div>
      <div class="setup-desc">Select your home station to get started. You can change this later.</div>
      <select id="setupStation"></select>
      <button class="setup-btn" id="setupSave">Save &amp; Continue</button>
    </div>
  </div>

  <script>
    // Schedule data will be loaded from external file
    let DATA = null;
    const STORAGE_KEY = 'caltrain-quick';

    // State
    let state = {
      homeStation: null,
      direction: 'n',
      destination: null,
      favorites: []
    };

    // Temporary state for reversed view (not persisted)
    let viewState = {
      isReversed: false,
      tempFrom: null,
      tempTo: null,
      expandedSection: null  // Track which section is expanded
    };

    // Load state from localStorage
    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {}
    }

    // Save state to localStorage
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // API Key management (stored separately)
    const API_KEY_STORAGE = 'caltrain-511-key';
    let liveStatusCache = {}; // Cache: trainNum -> {delay, timestamp}

    function getApiKey() {
      return localStorage.getItem(API_KEY_STORAGE);
    }

    function setApiKey(key) {
      if (key) {
        localStorage.setItem(API_KEY_STORAGE, key);
      } else {
        localStorage.removeItem(API_KEY_STORAGE);
      }
      updateApiStatusDisplay();
    }

    function extractApiKey(input) {
      // Extract UUID pattern from input (handles pasting whole email)
      const match = input.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
      return match ? match[0] : null;
    }

    function checkUrlForApiKey() {
      const params = new URLSearchParams(window.location.search);
      const key = params.get('apikey') || params.get('key');
      if (key) {
        const extracted = extractApiKey(key);
        if (extracted) {
          setApiKey(extracted);
          // Clean URL without reloading
          window.history.replaceState({}, '', window.location.pathname);
        }
      }
    }

    function updateApiStatusDisplay() {
      const statusEl = document.getElementById('apiStatus');
      const key = getApiKey();
      if (key) {
        statusEl.className = 'api-status connected';
        statusEl.textContent = `API key configured: ${key.slice(0, 8)}...`;
      } else {
        statusEl.className = 'api-status disconnected';
        statusEl.textContent = 'No API key configured';
      }
    }

    // Fetch live status from 511.org API
    async function fetchLiveStatus(stationId, direction) {
      const apiKey = getApiKey();
      if (!apiKey) return null;

      const stopId = DATA.stops511?.[stationId]?.[direction];
      if (!stopId) return null;

      try {
        const url = `https://api.511.org/transit/StopMonitoring?api_key=${apiKey}&agency=CT&stopCode=${stopId}&format=json`;
        const response = await fetch(url);
        if (!response.ok) return null;

        const data = await response.json();
        const visits = data?.ServiceDelivery?.StopMonitoringDelivery?.MonitoredStopVisit || [];

        // Build delay map: trainNum -> delay in minutes
        const delayMap = {};
        visits.forEach(visit => {
          const journey = visit.MonitoredVehicleJourney;
          const call = journey?.MonitoredCall;
          if (!call) return;

          const trainNum = journey.FramedVehicleJourneyRef?.DatedVehicleJourneyRef;
          const aimed = call.AimedDepartureTime || call.AimedArrivalTime;
          const expected = call.ExpectedDepartureTime || call.ExpectedArrivalTime;

          if (trainNum && aimed && expected) {
            const aimedTime = new Date(aimed).getTime();
            const expectedTime = new Date(expected).getTime();
            const delayMins = Math.round((expectedTime - aimedTime) / 60000);
            delayMap[trainNum] = delayMins;
          }
        });

        return delayMap;
      } catch (e) {
        console.error('Failed to fetch live status:', e);
        return null;
      }
    }

    // Get service type for today (or previous day if before 3am)
    function getServiceType() {
      let now = new Date();

      // Before 3am, use previous day's service type (GTFS service day runs ~4am to ~3am)
      if (now.getHours() < 3) {
        now = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      }

      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
      const day = now.getDay();

      // Check holidays first
      if (DATA.holidays[dateStr]) {
        return 'weekend';
      }

      // Weekend
      if (day === 0 || day === 6) {
        return 'weekend';
      }

      return 'weekday';
    }

    // Format minutes to time string
    function formatTime(minutes) {
      let h = Math.floor(minutes / 60) % 24;  // Wrap to 0-23 for times past midnight
      const m = minutes % 60;
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return `${h}:${m.toString().padStart(2, '0')}${ampm}`;
    }

    // Get current minutes since midnight (or since previous midnight for late-night service)
    // GTFS service day runs ~4am to ~3am next day, so before 3am we treat it as previous day's late-night
    function getCurrentMinutes() {
      const now = new Date();
      const mins = now.getHours() * 60 + now.getMinutes();
      // Before 3am, add 24 hours to treat as previous day's late-night service
      return mins < 180 ? mins + 24 * 60 : mins;
    }

    // Get route type name and class
    function getRouteType(type) {
      const types = [
        { name: 'Local', class: 'type-local' },
        { name: 'Limited', class: 'type-limited' },
        { name: 'Express', class: 'type-express' },
        { name: 'S. County', class: 'type-local' }
      ];
      return types[type] || types[0];
    }

    // Populate station dropdowns
    function populateStations() {
      const homeSelect = document.getElementById('homeStation');
      const destSelect = document.getElementById('destStation');
      const setupSelect = document.getElementById('setupStation');

      const options = DATA.stations.map(s =>
        `<option value="${s.id}">${s.name}</option>`
      ).join('');

      homeSelect.innerHTML = options;
      setupSelect.innerHTML = options;
      homeSelect.disabled = false;

      updateDestinations();
    }

    // Update destination dropdown based on direction
    function updateDestinations() {
      const destSelect = document.getElementById('destStation');
      const homeIdx = DATA.stations.findIndex(s => s.id === state.homeStation);

      // Calculate available stations for each direction
      const northStations = DATA.stations.slice(0, homeIdx).reverse(); // Nearest first
      const southStations = DATA.stations.slice(homeIdx + 1); // Already nearest first

      // Update direction tab states
      const northBtn = document.querySelector('.dir-btn[data-dir="n"]');
      const southBtn = document.querySelector('.dir-btn[data-dir="s"]');

      northBtn.disabled = northStations.length === 0;
      southBtn.disabled = southStations.length === 0;

      // Auto-switch direction if current has no stations
      if (state.direction === 'n' && northStations.length === 0 && southStations.length > 0) {
        state.direction = 's';
        northBtn.classList.remove('active');
        southBtn.classList.add('active');
      } else if (state.direction === 's' && southStations.length === 0 && northStations.length > 0) {
        state.direction = 'n';
        southBtn.classList.remove('active');
        northBtn.classList.add('active');
      }

      const stations = state.direction === 'n' ? northStations : southStations;

      const options = '<option value="">Select destination</option>' +
        stations.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

      destSelect.innerHTML = options;

      if (state.destination) {
        destSelect.value = state.destination;
      }

      updateFavorites();
    }

    // Update favorites buttons
    function updateFavorites() {
      const container = document.getElementById('favorites');
      const homeIdx = DATA.stations.findIndex(s => s.id === state.homeStation);

      // Filter favorites to only show valid ones for current direction
      const validFavs = state.favorites.filter(fav => {
        const favIdx = DATA.stations.findIndex(s => s.id === fav);
        if (state.direction === 'n') {
          return favIdx < homeIdx;
        } else {
          return favIdx > homeIdx;
        }
      });

      if (validFavs.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = validFavs.map(fav => {
        const station = DATA.stations.find(s => s.id === fav);
        const isActive = fav === state.destination;
        return `<button class="fav-btn ${isActive ? 'active' : ''}" data-station="${fav}">${station.name}</button>`;
      }).join('');
    }

    // Get current effective from/to stations
    function getEffectiveStations() {
      if (viewState.isReversed) {
        return {
          from: viewState.tempFrom,
          to: viewState.tempTo,
          direction: state.direction === 'n' ? 's' : 'n'
        };
      }
      return {
        from: state.homeStation,
        to: state.destination,
        direction: state.direction
      };
    }

    // Render a single train row
    function renderTrain(t, currentMinutes, liveDelay = null) {
      const [time, trainNum, routeType] = t;
      const route = getRouteType(routeType);
      const eta = time - currentMinutes;

      let etaText, etaClass = '';
      if (eta <= 0) {
        etaText = 'Now';
        etaClass = 'eta-now';
      } else if (eta <= 10) {
        etaText = `${eta} min`;
        etaClass = 'eta-soon';
      } else if (eta < 60) {
        etaText = `${eta} min`;
      } else {
        const hrs = Math.floor(eta / 60);
        const mins = eta % 60;
        etaText = mins > 0 ? `${hrs}h ${mins}m` : `${hrs}h`;
      }

      // Live status badge (only for trains within ~1 hour)
      let statusBadge = '';
      if (liveDelay !== null && eta <= 60) {
        if (liveDelay < 0) {
          statusBadge = `<span class="live-status status-early">${liveDelay} min</span>`;
        } else if (liveDelay === 0) {
          statusBadge = '<span class="live-status status-ontime">On time</span>';
        } else {
          statusBadge = `<span class="live-status status-late">+${liveDelay} min</span>`;
        }
      }

      return `
        <div class="train">
          <div class="train-time">${formatTime(time)}</div>
          <div class="train-info">
            <div class="train-number">Train ${trainNum}${statusBadge}</div>
            <span class="train-type ${route.class}">${route.name}</span>
          </div>
          <div class="train-eta ${etaClass}">${etaText}</div>
        </div>
      `;
    }

    // Render a collapsible section
    function renderCollapsibleSection(id, label, trains, currentMinutes, liveDelays = {}) {
      if (trains.length === 0) return '';

      const firstTime = formatTime(trains[0][0]);
      const lastTime = formatTime(trains[trains.length - 1][0]);
      const timeRange = trains.length === 1 ? firstTime : `${firstTime} - ${lastTime}`;

      return `
        <div class="train-section">
          <button class="section-toggle" data-section="${id}">
            <span class="section-toggle-text">
              <span>${label}</span>
              <span class="section-count">${trains.length}</span>
              <span class="section-time">${timeRange}</span>
            </span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
          <div class="collapsible-list" id="${id}">
            ${trains.map(t => renderTrain(t, currentMinutes, liveDelays[t[1]])).join('')}
          </div>
        </div>
      `;
    }

    // Update train list
    async function updateTrains() {
      const container = document.getElementById('trainList');
      const { from, to, direction } = getEffectiveStations();

      if (!to) {
        container.innerHTML = '<div class="no-trains">Select a destination to see trains</div>';
        return;
      }

      const serviceType = getServiceType();
      const serviceFilter = serviceType === 'weekday' ? 0 : 1;
      const currentMinutes = getCurrentMinutes();

      const scheduleKey = direction === 'n' ? 'n' : 's';
      const originSchedule = DATA.schedule[from]?.[scheduleKey] || [];
      const destSchedule = DATA.schedule[to]?.[scheduleKey] || [];

      // Get set of train numbers that stop at destination
      const destTrainNums = new Set(
        destSchedule
          .filter(t => t[3] === serviceFilter)
          .map(t => t[1])
      );

      // Filter trains: correct service type, stops at destination, departing today
      const endOfDay = 24 * 60 + 120; // Until 2am
      let allTrains = originSchedule.filter(t => {
        const [time, trainNum, , svc] = t;
        return svc === serviceFilter &&
               time >= currentMinutes &&
               time <= endOfDay &&
               destTrainNums.has(trainNum);
      });

      if (allTrains.length === 0) {
        const noServiceMsg = destTrainNums.size === 0
          ? `No ${serviceType} service to this station`
          : 'No more trains today';
        container.innerHTML = `<div class="no-trains">${noServiceMsg}</div>`;
        return;
      }

      // Split into buckets: Next (first 6), Later (next 6), Rest
      const BUCKET_SIZE = 6;
      const nextTrains = allTrains.slice(0, BUCKET_SIZE);
      const laterTrains = allTrains.slice(BUCKET_SIZE, BUCKET_SIZE * 2);
      const restTrains = allTrains.slice(BUCKET_SIZE * 2);

      // Fetch live status (non-blocking, will update UI when ready)
      let liveDelays = {};
      if (getApiKey()) {
        // First render without live status
        renderTrainList(container, nextTrains, laterTrains, restTrains, currentMinutes, {});
        // Then fetch and update with live status
        const delays = await fetchLiveStatus(from, direction);
        if (delays) {
          liveDelays = delays;
          renderTrainList(container, nextTrains, laterTrains, restTrains, currentMinutes, liveDelays);
        }
      } else {
        renderTrainList(container, nextTrains, laterTrains, restTrains, currentMinutes, {});
      }
    }

    // Helper to render the train list (used by updateTrains)
    function renderTrainList(container, nextTrains, laterTrains, restTrains, currentMinutes, liveDelays) {
      let html = '';

      // Next trains - always visible
      const nextFirstTime = formatTime(nextTrains[0][0]);
      const nextLastTime = formatTime(nextTrains[nextTrains.length - 1][0]);
      const nextTimeRange = nextTrains.length === 1 ? nextFirstTime : `${nextFirstTime} - ${nextLastTime}`;

      html += `
        <div class="train-section">
          <div class="section-header">
            <span>Next trains</span>
            <span class="section-count">${nextTrains.length}</span>
            <span class="section-time">${nextTimeRange}</span>
          </div>
          <div class="train-list">
            ${nextTrains.map(t => renderTrain(t, currentMinutes, liveDelays[t[1]])).join('')}
          </div>
        </div>
      `;

      // Later trains - collapsible
      html += renderCollapsibleSection('laterTrains', 'Later', laterTrains, currentMinutes, liveDelays);

      // Rest of day - collapsible
      html += renderCollapsibleSection('restTrains', 'Rest of day', restTrains, currentMinutes, liveDelays);

      container.innerHTML = html;

      // Restore expanded section if any
      if (viewState.expandedSection) {
        const btn = container.querySelector(`[data-section="${viewState.expandedSection}"]`);
        const list = document.getElementById(viewState.expandedSection);
        if (btn && list) {
          btn.classList.add('open');
          list.classList.add('open');
        }
      }

      // Add toggle listeners with auto-collapse
      container.querySelectorAll('.section-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const sectionId = btn.dataset.section;
          const list = document.getElementById(sectionId);
          const isOpening = !btn.classList.contains('open');

          // Auto-collapse other sections when opening this one
          if (isOpening) {
            container.querySelectorAll('.section-toggle').forEach(otherBtn => {
              if (otherBtn !== btn) {
                otherBtn.classList.remove('open');
                const otherId = otherBtn.dataset.section;
                document.getElementById(otherId)?.classList.remove('open');
              }
            });
            viewState.expandedSection = sectionId;
          } else {
            viewState.expandedSection = null;
          }

          btn.classList.toggle('open');
          list.classList.toggle('open');
        });
      });
    }  // end renderTrainList

    // Add to favorites
    function addToFavorites(stationId) {
      if (!state.favorites.includes(stationId)) {
        state.favorites = [stationId, ...state.favorites].slice(0, 5);
        saveState();
      }
    }

    // Update service type display
    function updateServiceDisplay() {
      const serviceType = getServiceType();
      document.getElementById('serviceType').textContent =
        serviceType === 'weekday' ? 'Weekday' : 'Weekend';
    }

    // Check schedule expiry
    function checkScheduleExpiry() {
      if (!DATA?.validTo) return;
      const now = new Date();
      const validTo = new Date(
        DATA.validTo.slice(0, 4),
        parseInt(DATA.validTo.slice(4, 6)) - 1,
        DATA.validTo.slice(6, 8)
      );
      const daysUntilExpiry = Math.ceil((validTo - now) / (1000 * 60 * 60 * 24));

      if (daysUntilExpiry <= 14) {
        document.getElementById('expiryWarning').classList.remove('hidden');
      }
    }

    // Swap stations for return trip view
    function swapStations() {
      if (!state.destination) return;

      viewState.isReversed = !viewState.isReversed;

      if (viewState.isReversed) {
        // Store current state for reversal
        viewState.tempFrom = state.destination;
        viewState.tempTo = state.homeStation;

        // Update UI to show reversed state
        document.getElementById('reversedBanner').classList.remove('hidden');
        document.getElementById('homeStation').value = viewState.tempFrom;
        document.getElementById('homeStation').disabled = true;

        // Update "To" dropdown to only show the original home station
        const destSelect = document.getElementById('destStation');
        const homeStationData = DATA.stations.find(s => s.id === state.homeStation);
        destSelect.innerHTML = `<option value="${state.homeStation}">${homeStationData.name}</option>`;
        destSelect.disabled = true;

        // Hide direction toggle and favorites in reversed mode
        document.querySelector('.direction-toggle').style.display = 'none';
        document.getElementById('favorites').style.display = 'none';
      } else {
        resetToNormalView();
      }

      updateTrains();
    }

    // Reset to normal view
    function resetToNormalView() {
      viewState.isReversed = false;
      viewState.tempFrom = null;
      viewState.tempTo = null;

      document.getElementById('reversedBanner').classList.add('hidden');
      document.getElementById('homeStation').value = state.homeStation;
      document.getElementById('homeStation').disabled = false;

      // Restore direction toggle and favorites
      document.querySelector('.direction-toggle').style.display = 'flex';
      document.getElementById('favorites').style.display = 'flex';

      // Restore destination dropdown
      document.getElementById('destStation').disabled = false;
      updateDestinations();
      updateTrains();
    }

    // Initialize app
    async function init() {
      loadState();
      checkUrlForApiKey();  // Check for API key in URL
      updateApiStatusDisplay();  // Update API status display

      // Load schedule data
      try {
        const response = await fetch('schedule-data.min.json');
        DATA = await response.json();
      } catch (e) {
        console.error('Failed to load schedule data:', e);
        return;
      }

      // Update valid until date
      if (DATA.validTo) {
        const y = DATA.validTo.slice(0, 4);
        const m = DATA.validTo.slice(4, 6);
        const d = DATA.validTo.slice(6, 8);
        document.getElementById('validUntil').textContent = `${m}/${d}/${y}`;
      }

      populateStations();
      updateServiceDisplay();
      checkScheduleExpiry();

      // Show setup if no home station
      if (!state.homeStation) {
        document.getElementById('setupModal').classList.remove('hidden');
        // Default to Palo Alto
        document.getElementById('setupStation').value = 'palo_alto';
      } else {
        document.getElementById('homeStation').value = state.homeStation;
        updateDestinations();
        updateTrains();
      }

      // Event listeners
      document.getElementById('homeStation').addEventListener('change', (e) => {
        if (viewState.isReversed) return; // Ignore in reversed mode
        state.homeStation = e.target.value;
        state.destination = null;
        saveState();
        updateDestinations();
        updateTrains();
      });

      document.getElementById('destStation').addEventListener('change', (e) => {
        state.destination = e.target.value;
        if (state.destination) {
          addToFavorites(state.destination);
        }
        updateTrains();
        updateFavorites();
      });

      document.querySelectorAll('.dir-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.direction = btn.dataset.dir;
          state.destination = null;
          updateDestinations();
          updateTrains();
        });
      });

      document.getElementById('favorites').addEventListener('click', (e) => {
        if (e.target.classList.contains('fav-btn')) {
          state.destination = e.target.dataset.station;
          document.getElementById('destStation').value = state.destination;
          updateTrains();
          updateFavorites();
        }
      });

      document.getElementById('setupSave').addEventListener('click', () => {
        state.homeStation = document.getElementById('setupStation').value;
        saveState();
        document.getElementById('homeStation').value = state.homeStation;
        document.getElementById('setupModal').classList.add('hidden');
        updateDestinations();
        updateTrains();
      });

      document.getElementById('changeHome').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('setupModal').classList.remove('hidden');
        document.getElementById('setupStation').value = state.homeStation;
      });

      // Swap button
      document.getElementById('swapBtn').addEventListener('click', swapStations);

      // Reset button (back to home)
      document.getElementById('resetTrip').addEventListener('click', resetToNormalView);

      // API key modal
      document.getElementById('openApiSettings').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('apiKeyInput').value = getApiKey() || '';
        updateApiStatusDisplay();
        document.getElementById('apiModal').classList.remove('hidden');
      });

      document.getElementById('apiCancel').addEventListener('click', () => {
        document.getElementById('apiModal').classList.add('hidden');
      });

      document.getElementById('apiSave').addEventListener('click', () => {
        const input = document.getElementById('apiKeyInput').value.trim();
        const key = extractApiKey(input);
        if (key) {
          setApiKey(key);
          document.getElementById('apiModal').classList.add('hidden');
          updateTrains();  // Refresh to fetch live status
        } else if (input === '') {
          // Clear key if input is empty
          setApiKey(null);
          document.getElementById('apiModal').classList.add('hidden');
          updateTrains();
        } else {
          alert('Could not find a valid API key. Please paste the full key or email.');
        }
      });

      // Refresh every minute (expanded state is preserved)
      setInterval(() => {
        updateServiceDisplay();
        updateTrains();
      }, 60000);
    }

    // Start app
    init();

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
